<style>
    body {
        font-family: monospace;
        font-size: 12px;
        width: 100%;
        height: 100%;
        margin: 0px;
        overflow-y: hidden;
        overflow-x: hidden;
    }
    #path {
        background-color: #eee8d5;
        font-size: 12px;
        position: absolute;
        top: 0px;
        left: 0px;
        margin: 0px;
        padding: 6px 10px 6px 10px;
        border-radius: 3px;
    }
    #scene {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
        background-color: #fdf6e3;
        background-size: 30px 30px;
        background-image:
            linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
    }
    #stage {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 120px;
        height: 95vh;
        overflow-x: scroll;
        border: 1px solid;
        border-radius: 3px;
        z-index: 2;
        background-color: #eee8d5;
    }
    .nodeInStage {
        position: relative;
        margin: 10px;
        z-index: 3;
    }
    .nodeInScene {
        position: absolute;
    }
    .textNode {
        margin: 0px;
        padding: 10px;
        border-radius: 5px;
        background-color: #eee8d5;

        box-shadow: none;
        outline-style: none;
        border-color: transparent;
        overflow-wrap: break-word;
    }
    .dirNode {
        margin: 0px;
        padding: 10px;
        border-radius: 5px;
        background-color: #eee8e7;

        text-align: center;
        word-break: break-all;
    }
</style>

<div id="scene"></div>
<div id="stage"></div>

<script src="./math.js"></script>
<script src="./canvas.js"></script>

<script>
const scene = new Scene(document.getElementById("scene"));
const stage = new Stage(document.getElementById("stage"));

const resetCanvas = () => {
    for (const child of scene.children) {
      scene.elem.removeChild(child.elem);
      scene.children = [];
    }

    for (const child of stage.children) {
      stage.elem.removeChild(child.elem);
      stage.children = [];
    }

    const title = document.getElementById("path");
    if (title) title.remove();
}

let ws = new WebSocket("ws://localhost:1234/ws");
ws.onmessage = e => {
    resetCanvas();
    const {files, layout, path} = JSON.parse(e.data);

    // Create title
    const p = document.createElement("p");
    p.setAttribute("id", "path");
    p.innerHTML = `CS_Store > ${path}`;
    p.style.zIndex = 5;
    document.body.appendChild(p);

    // Populate stage with listing
    files.map(d => {
        stage.addNode(new Node({
            x: 0,
            y: 0,
            z: 4,
            w: 200,
            data: d,
        }));
    })

    // Populate scene with layout
    if (Object.keys(layout).length > 0) {
        scene.origin = new Vec(layout.origin);
        scene.scale = layout.scale;
        for (const child of layout.children) {
            scene.addNode(new Node(child))
        }
    }
}
ws.onopen = e => {
    ws.send(JSON.stringify({"type": "initialize"}));

    const autosave = () => {
        ws.send(JSON.stringify({
            "type": "layout",
            "layout": scene.serialize(),
        }));
        setTimeout(autosave, 1000);
    }
    autosave();
}
</script>
